/*
 * Demonstrates usage of GCC built-in functions to extract and manipulate
 * the return address of the current function.
 *
 * The code prints the return address, then attempts to modify it to
 * jump to another location in code by altering the stored return address.
 *
 * also possible to use goto to jump to the final function by address.
 * no-pie compilation enables randomization disables the demonstrated manipulations.
 */


#include <stdio.h>

void finish(int a, int b) 
{
	void *addr = __builtin_extract_return_addr(__builtin_return_address(0));
		printf("Return address %p\n", addr);
		
		
  if (42 == a) {
    printf("That's an interesting value for a.\n");
  }
  if (0 == b) {
    printf("How mundane.\n");
  }
  if (32767 == a * b) {
    printf("Keep in mind that neither success not failure is ever final.\n");
  }
  if (8001 == a * b || 9001 == a * b) {
    printf("Realize that while the first 90 percent of code accounts for 90 "
           "percent of the development time, so does the last 10 percent of "
           "the code.");
  }

  printf("You've successfully finished this part of the exercise.\n");
}

void func() {
	// Add code here
	int x = 1010000;
	long *addr = (long *)__builtin_extract_return_addr(__builtin_return_address(0));

	printf("Return address %p\n", addr);

	*addr = addr - 21;
	/*goto *addr;*/
	
	
	/*finish(1,2);*/
	
	
	/*void* ret = 0x555555555178;
	goto *ret;*/
}

int main() {
  func();

  return 0;
}
